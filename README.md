# Implementa√ß√£o de integra√ß√£o por Modbus TCP/IP, em Prova de Conceito, de sistema supervis√£o, controle e planta virtual

*Trabalho Pr√°tico II da disciplina de Redes para Controle e Automa√ß√£o [2024/2], ministrada pelo professor [Rafael Emerick Zape de Oliveira](https://github.com/rafaelrezo).*
**O presente trabalho √© de autoria intregal da aluna [Sofia de Alcantara](https://github.com/sofialctv)**.

![Ilustra√ß√£o.](/img/capa.avif)

# Introdu√ß√£o
O objetivo desse trabalho se d√° por implementar a integra√ß√£o de tr√™s diferentes plataformas (sistema supervis√≥rio, sistema de controle e a planta virtual), visando a disponibiliza√ß√£o de um ambiente de testes para supervis√£o Modbus TCP/IP.

> üìÉ As orienta√ß√µes completas de execu√ß√£o da atividade podem ser lidas no arquivo [especificacao.pdf](especificacao.pdf).

# Contextualiza√ß√£o
Para melhor entendimento dos resultados obtidos nesse trabalho, √© de extrema import√¢ncia a contextualiza√ß√£o de conceitos presentes durante toda a execu√ß√£o da tarefa. Isso posto, vamos come√ßar entendendo melhor do que se trata o protocolo **ModbusTCP/IP**.

## Modbus TCP/IP

Em ambientes industriais, √© comum existir uma variedade de dispositivos, como CLPs (Controladores L√≥gicos Program√°veis), sensores, atuadores e sistemas supervis√≥rios, que precisam se comunicar entre si para garantir o funcionamento correto e integrado de processos complexos. 

Um dos recursos para estabelecimento da comunica√ß√£o entre dispositivos √© o protocolo **Modbus TCP/IP** desenvolvido na d√©cada de 1970 pela Modicon e se constituindo como um dos protocolos de comunica√ß√£o mais amplamente utilizados em sistemas de automa√ß√£o industrial.

Baseado no **padr√£o Ethernet** e no **protocolo TCP/IP**, o **Modbus TCP/IP** disp√µe da simplicidade e robustez (mantendo a estrutura da mensagem, comunica√ß√£o baseada em registro, etc.) do protocolo Modbus original, adicionando confiabilidade e interoperabilidade do TCP/IP. Ele encapsula os dados Modbus tradicionais em um pacote TCP/IP, permitindo que os dados sejam transportados por infraestruturas de rede padr√£o. 

Recomendo a leitura do artigo **"[Understanding Modbus TCP-IP: An In depth Exploration](https://www.wevolver.com/article/modbus-tcp-ip#modbus-tcp/ip:-basic-concepts-and-principles)"** caso deseje se aprofundar quanto ao protocolo.

## Dispostivos Industriais

Como citados anteriormente, os sistemas de automa√ß√£o industrial dependem de uma variedade de dispositivos que trabalham em conjunto para controlar e monitorar processos complexos.

Entre esses dispositivos, destacam-se os **CLPs (Controladores L√≥gicos Program√°veis)**, os **sistemas supervis√≥rios** e as **plantas industriais**. Cada um desempenha um papel crucial na automa√ß√£o, e entender suas fun√ß√µes auxiliar√° na compreens√£o geral do trabalho.

### CLPs (Controladores L√≥gicos Program√°veis)
Os CLPs s√£o dispositivos eletr√¥nicos program√°veis projetados para controlar m√°quinas e processos industriais. Por meio de uma linguagem de programa√ß√£o, como **Ladder** os CLPs executam l√≥gicas de controle que determinam como os equipamentos devem operar. 

O CLP utilizado no contexto do trabalho ser√° configurado utilizando a solu√ß√£o open source **[OpenPLC](https://github.com/thiagoralves/OpenPLC_v3)**.

### Sistemas Supervis√≥rios
Os sistemas supervis√≥rios s√£o softwares que permitem monitorar e controlar processos industriais de forma centralizada, coletando dados dos CLPs e outros dispositivos e exibindo-os em uma interface gr√°fica amig√°vel (IHM - Interface Homem-M√°quina).

O sistema supervis√≥rio escolhido para instala√ß√£o foi o **[Mango-OS](https://radixiot.com/mango-os)**.

### Plantas Industriais
Por fim, as plantas industriais representam o ambiente f√≠sico onde os processos industriais ocorrem. Compostas por m√°quinas, equipamentos, sensores e atuadores que interagem entre si para realizar tarefas espec√≠ficas.

Em um ambiente de automa√ß√£o, a planta √© controlada pelos CLPs e monitorada pelo sistema supervis√≥rio. Juntos, esses dispositivos formam a base dos sistemas de automa√ß√£o industrial, permitindo que processos complexos sejam executados de forma eficiente, segura e confi√°vel.

Para a configura√ß√£o da nossa planta virtual utilizaremos o **[Node Red](https://nodered.org/)**.

# Infraestrutura e Configura√ß√£o
Feita a contextualiza√ß√£o inicial e apresenta√ß√£o dos conceitos recorrentes ao trabalho, seguimos para explana√ß√£o da infraestrutura escolhida.

## M√°quinas Virtuais

Foram criadas tr√™s inst√¢ncias (representando o sistema supervis√≥rio, sistema de controle e a planta virtua) EC2 utilizando a infraestrutura da AWS Academy.

Para garantir a seguran√ßa e o funcionamento adequado dessas m√°quinas virtuais, foi essencial configurar corretamente os **grupos de seguran√ßa** na AWS, que atuam como um *firewall* virtual, controlando o tr√°fego de rede para as inst√¢ncias EC2.

### Firewall e Grupos de Seguran√ßa na AWS
Um **firewall** √© um dispositivo de seguran√ßa que monitora o tr√°fego de rede de entrada e sa√≠da e decide permitir ou bloquear tr√°fegos espec√≠ficos de acordo com um conjunto definido de regras de seguran√ßa. Na AWS, essa funcionalidade √© implementada por meio dos grupos de seguran√ßa, que atuam como firewalls virtuais para as inst√¢ncias EC2.

### IPs Din√¢micos e Est√°ticos
Outro detalhe importante √© que na AWS, a configura√ß√£o padr√£o para inst√¢ncias EC2 utiliza **IPs din√¢micos**, o que significa que o endere√ßo IP associado a uma inst√¢ncia pode mudar sempre que essa √© reiniciada ou interrompida. 

No contexto deste projeto, a utiliza√ß√£o de IPs din√¢micos poderia causar falhas de comunica√ß√£o sempre que os endere√ßos IP das inst√¢ncias mudassem, interrompendo o funcionamento dos sistemas e exigindo reconfigura√ß√µes manuais frequentes.

Por isso, foram configurados **IPs est√°ticos** (tamb√©m conhecidos como Elastic IPs na AWS) para cada uma das inst√¢ncias EC2. Um Elastic IP √© um endere√ßo IP p√∫blico *fixo* que garante que o endere√ßo IP n√£o mude mesmo ap√≥s reinicializa√ß√µes ou interrup√ß√µes das VMs.

# OpenPLC: CLP Virtual
Fazendo uso do OpenPLC Editor, foi implementada em **ladder** uma planta industrial simulada (veja o projeto no diret√≥rio [openplc-editor](./openplc-editor/)).

![Planta ladder feita via OpenPLC Editor.](/img/planta-ladder.png)
*Figura 1: Planta ladder feita via OpenPLC Editor.*

O detalhe mais importante a ser observado √© o campo `Localiza√ß√£o`, que √© fundamental para definir o endere√ßamento das vari√°veis utilizadas no programa ladder. Esse campo especifica onde a vari√°vel est√° localizada na mem√≥ria do PLC, e o endere√ßamento segue o padr√£o Modbus.

## Endere√ßamento Modbus
O protocolo Modbus utiliza um esquema de endere√ßamento que permite acessar diferentes tipos de registros, entre eles:

- **Coils (Discretas de Sa√≠da)**, que s√£o usados para vari√°veis booleanas de sa√≠da.
- **Discrete Inputs (Entradas Discretas)**, que s√£o usados para vari√°veis booleanas de entrada.
- **Holding Registers (Registradores de Manuten√ß√£o)**, que s√£o usados para vari√°veis do tipo inteiro (16 bits) ou float (32 bits).
- **Input Registers (Registradores de Entrada)**, que s√£o usados para vari√°veis de entrada do tipo inteiro ou float.

Com apoio da [tabela de endere√ßamento Modbus](https://autonomylogic.com/docs/2-5-modbus-addressing/), o campo `Localiza√ß√£o` foi preenchido para mapear vari√°veis remotas que ser√£o utilizadas no sistema supervis√≥rio para intera√ß√£o.

## OpenPLC Runtime
Configurada a planta e gerado o arquivo `.st` da mesma ([planta-ladder.st](/openplc-runtime/planta-ladder.st)), configuramos o script PSM.

### PSM: Python SoftPLC Module
A PSM √© uma biblioteca Python usada para simular ou controlar um SoftPLC (um PLC implementado em software), que permite que voc√™ interaja com vari√°veis de um sistema de controle, como entradas e sa√≠das digitais/anal√≥gicas, mem√≥rias, etc., de forma program√°tica. Veja o script desenvolvido em [psm.py](/openplc-runtime/psm.py).

# Node Red: Planta Virtual
Partindo agora para o Node-RED, o [fluxo](/node-red/flows.json) simula um sistema de controle de processos, no qual h√° comunica√ß√£o entre um atuador, uma planta (processo controlado) e um sensor, utilizando a infraestrutura de comunica√ß√£o TCP para enviar e receber dados. 

![ Fluxo no Node-RED.](/img/flow.png)
*Figura 2: Fluxo no Node-RED.*

A simula√ß√£o utiliza comunica√ß√£o TCP em dois pontos:
- **Entrada (TCP 1515)**: Recebe o erro ou valor de controle externo.
- **Sa√≠da (TCP 1516)**: Envia a vari√°vel de processo (PV) medida de volta para outros sistemas ou supervisores.

# MangoOS: Supervis√≥rio

No sistema supervis√≥rio, foi configurada uma fonte de dados (**data source**) utilizando o PLC como host, e o **endere√ßo IP privado** do PLC foi especificado para estabelecer a conex√£o. O uso de um IP privado √© poss√≠vel porque as m√°quinas que hospedam o MangoOS e o OpenPLC est√£o na **mesma rede local**, na AWS.

![Painel mostrando os data points configurados no MangoOS, com base nas vari√°veis remotas do PLC virtual.](img/mango-data-points.png)
*Figura 3: Painel mostrando os data points configurados no MangoOS, com base nas vari√°veis remotas do PLC virtual.*

Ap√≥s a conex√£o com o PLC ser estabelecida, o pr√≥ximo passo foi configurar os **data points** no MangoOS. Para isso, foi necess√°rio associar as posi√ß√µes das vari√°veis no programa ladder do PLC aos respectivos **register ranges** e **offsets** no supervis√≥rio, garantindo que as vari√°veis do PLC virtual fossem corretamente monitoradas e controladas pelo MangoOS.

# Resultados

O sistema integrado foi capaz de executar o controle e supervis√£o do processo industrial simulado de maneira eficaz. A planta virtual, desenvolvida no **Node-RED**, recebeu comandos do controlador implementado no **OpenPLC** e enviou de volta os dados de processo monitorados pelo **MangoOS**.

![alt text](img/running.gif)
*GIF demonstrando funcionamento dos sistemas integrados.*

No GIF acima, observamos a intera√ß√£o entre as tr√™s plataformas:

1. **Node-RED**: Visualizamos o fluxo do processo de controle, onde o atuador ajusta a planta com base no valor de controle (CV) e a planta responde, retornando a vari√°vel de processo (PV) medida pelo sensor. Esse feedback √© enviado para o sistema supervis√≥rio para ser monitorado.

2. **OpenPLC**: Na aba de monitoramento do **OpenPLC Runtime**, √© poss√≠vel observar os valores atualizados de par√¢metros como Setpoint (SP), Processo (PV) e Controle (CV), juntamente com a visualiza√ß√£o do comportamento din√¢mico do sistema, conforme os valores de controle s√£o ajustados.

3. **MangoOS**: No sistema supervis√≥rio, temos uma visualiza√ß√£o gr√°fica do n√≠vel da planta simulada, representando visualmente a vari√°vel de processo (PV). O gr√°fico √† direita da tela mostra a resposta temporal da planta, permitindo o acompanhamento em tempo real das mudan√ßas no sistema.


# Conclus√£o
O trabalho desenvolvido demonstra a efic√°cia da combina√ß√£o de diferentes ferramentas de automa√ß√£o para simular um ambiente de controle industrial, permitindo realizar testes e an√°lises em tempo real. O uso do protocolo **Modbus TCP/IP** foi essencial para a comunica√ß√£o fluida entre as plataformas, possibilitando uma supervis√£o e controle remotos de uma planta industrial virtual.

## Melhorias

Apesar do sucesso na execu√ß√£o do sistema, algumas melhorias podem ser implementadas para aumentar a robustez e efici√™ncia da solu√ß√£o, entre elas est√£o:

- **Aprimoramento da Seguran√ßa com Firewall e Grupos de Seguran√ßa,** permitindo tr√°fego desnecess√°rio de portas que n√£o est√£o sendo utilizadas. O ideal seria restringir as portas de comunica√ß√£o apenas √†s essenciais, como as portas TCP/IP do **Modbus** e aquelas necess√°rias para a interface de supervis√£o e controle remoto. 

- **Configura√ß√£o de DNS Personalizado para o Sistema Supervis√≥rio,** facilitando o acesso ao MangoOS por meio de um dom√≠nio amig√°vel, como `supervisorio.empresa.com`. Al√©m disso, a cria√ß√£o de certificados SSL tamb√©m poderia ser feita visando aumentar ainda mais a seguran√ßa das conex√µes.

- **Implementa√ß√£o de Logs de Eventos e Auditoria,** permitindo o rastreamento e armazenamento das atividades do sistema, como comandos executados e altera√ß√µes de par√¢metros, facilitando a identifica√ß√£o de problemas e a realiza√ß√£o de auditorias de seguran√ßa e operacionais.

### Refer√™ncias
1. https://www.wevolver.com/article/modbus-tcp-ip#modbus-tcp/ip:-basic-concepts-and-principles
2. https://www.sin.ufscar.br/servicos/conectividade/firewall/o-que-e-um-firewall
3. https://docs.aws.amazon.com/pt_br/AWSEC2/latest/UserGuide/elastic-ip-addresses-eip.html